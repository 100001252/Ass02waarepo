<!-- bookOrder BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Mon Mar 05 14:52:21 IST 2012 -->
<bpel:process name="bookOrder"
         targetNamespace="http://waa.hu"
         suppressJoinFailure="yes"
         xmlns:tns="http://waa.hu"
         xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:ns="http://waa.swin.artifacts" xmlns:ns0="http://waa.swin.edu.au" xmlns:ns1="http://hu.swin.waa" xmlns:ns2="http://sw.au">

    <!-- ================================================================= -->         
    <!-- ORCHESTRATION LOGIC                                               -->
    <!-- Set of activities coordinating the flow of messages across the    -->
    <!-- services integrated within this business process                  -->
    <!-- ================================================================= -->         
    <bpel:import namespace="http://waa.swin.artifacts" location="bookOrderArtifacts.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
    <bpel:partnerLinks>
        <bpel:partnerLink name="clientInputLink" partnerLinkType="ns:clientPLT" myRole="orderServicePro"></bpel:partnerLink>
        <bpel:partnerLink name="bookLibLink" partnerLinkType="ns:bookLibPLT" partnerRole="libServicePro"></bpel:partnerLink>
        <bpel:partnerLink name="studentLink" partnerLinkType="ns:studentPLT" partnerRole="studentServicePro"></bpel:partnerLink>
        <bpel:partnerLink name="bookShopLink" partnerLinkType="ns:bookShopPLT" partnerRole="bookShopServicePro"></bpel:partnerLink>
    </bpel:partnerLinks>
    <bpel:variables>
        <bpel:variable name="clientInputLinkRequest" messageType="ns:orderBookRequest"></bpel:variable>
        <bpel:variable name="clientInputLinkResponse" messageType="ns:orderBookResponse"></bpel:variable>
        <bpel:variable name="bookLibLinkResponse" messageType="ns0:isIsbnExistResponse"></bpel:variable>
        <bpel:variable name="bookLibLinkRequest" messageType="ns0:isIsbnExistRequest"></bpel:variable>
        <bpel:variable name="studentLinkResponse" messageType="ns1:isStudentExistResponse"></bpel:variable>
        <bpel:variable name="studentLinkRequest" messageType="ns1:isStudentExistRequest"></bpel:variable>
        <bpel:variable name="bookShopLinkResponse" messageType="ns2:validateAllThreeMessageResponse"></bpel:variable>
        <bpel:variable name="bookShopLinkRequest" messageType="ns2:validateAllThreeMessageRequest"></bpel:variable>
        <bpel:variable name="bookShopLinkResponse1" messageType="ns2:getAllDetailBookResponse"></bpel:variable>
        <bpel:variable name="bookShopLinkRequest1" messageType="ns2:getAllDetailBookRequest"></bpel:variable>
        <bpel:variable name="bookLibLinkResponse1" messageType="ns0:orderBookByBpelResponse"></bpel:variable>
        <bpel:variable name="bookLibLinkRequest1" messageType="ns0:orderBookByBpelRequest"></bpel:variable>
    </bpel:variables>
    <bpel:sequence name="main">
		
        <bpel:receive name="receiveInput" partnerLink="clientInputLink" operation="orderBook" portType="ns:bookOrderPortType" variable="clientInputLinkRequest" createInstance="yes"></bpel:receive>
        
        
        
        
        
        <bpel:flow name="Flow">
        <bpel:links>
                <bpel:link name="link1"></bpel:link>
                
                <bpel:link name="link3"></bpel:link>
                <bpel:link name="link4"></bpel:link>
                <bpel:link name="link5"></bpel:link>
                <bpel:link name="link2"></bpel:link>
                <bpel:link name="link6"></bpel:link>
            </bpel:links>
        <bpel:sequence name="Sequence">
                <bpel:assign validate="no" name="assignInput">
                    <bpel:copy>
                        <bpel:from><bpel:literal><ns:validateAllThreeMessage xmlns:ns="http://sw.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ns:isbn>ns:isbn</ns:isbn>
</ns:validateAllThreeMessage>
</bpel:literal></bpel:from>
                        <bpel:to variable="bookShopLinkRequest" part="parameters"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from><bpel:literal><ns:isStudentExist xmlns:ns="http://hu.swin.waa" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ns:studentId>0</ns:studentId>
  <ns:pin>ns:pin</ns:pin>
</ns:isStudentExist>
</bpel:literal></bpel:from>
                        <bpel:to variable="studentLinkRequest" part="parameters"></bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                <bpel:from><bpel:literal><ns:isIsbnExist xmlns:ns="http://waa.swin.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ns:isbn>ns:isbn</ns:isbn>
</ns:isIsbnExist>
</bpel:literal></bpel:from>
                <bpel:to variable="bookLibLinkRequest" part="parameters"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="parameters" variable="clientInputLinkRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[isbn]]></bpel:query>
                </bpel:from>
                <bpel:to part="parameters" variable="bookLibLinkRequest">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns0:isbn]]></bpel:query>
                </bpel:to>
            </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="clientInputLinkRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[studentId]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="studentLinkRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns1:studentId]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="clientInputLinkRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[pin]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="studentLinkRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns1:pin]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                    <bpel:copy>
                        <bpel:from part="parameters" variable="clientInputLinkRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[isbn]]></bpel:query>
                        </bpel:from>
                        <bpel:to part="parameters" variable="bookShopLinkRequest">
                            <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns2:isbn]]></bpel:query>
                        </bpel:to>
                    </bpel:copy>
                </bpel:assign>
                <bpel:sources>
                    <bpel:source linkName="link1"></bpel:source>
                    
                    <bpel:source linkName="link2"></bpel:source>
                    <bpel:source linkName="link6"></bpel:source>
                </bpel:sources>
            </bpel:sequence>
            
            <bpel:invoke name="invokeBookLib" partnerLink="bookLibLink" operation="isIsbnExist" portType="ns0:Ass02BookSoapPortType" inputVariable="bookLibLinkRequest" outputVariable="bookLibLinkResponse">
                <bpel:targets>
                    <bpel:target linkName="link1"></bpel:target>
                </bpel:targets>
                <bpel:sources>
                    <bpel:source linkName="link3"></bpel:source>
                </bpel:sources>
            </bpel:invoke>
            
            <bpel:invoke name="invokeStudnt" partnerLink="studentLink" operation="isStudentExist" portType="ns1:Ass02StudentSoapPortType" inputVariable="studentLinkRequest" outputVariable="studentLinkResponse">
                <bpel:sources>
                    <bpel:source linkName="link4"></bpel:source>
                </bpel:sources>
                <bpel:targets>
                    <bpel:target linkName="link6"></bpel:target>
                </bpel:targets>
            </bpel:invoke>
            
            <bpel:invoke name="invokeBookShop" partnerLink="bookShopLink" operation="validateAllThreeMessage" portType="ns2:Ass02BookInformationPortType" inputVariable="bookShopLinkRequest" outputVariable="bookShopLinkResponse">
                <bpel:sources>
                    <bpel:source linkName="link5"></bpel:source>
                </bpel:sources>
                <bpel:targets>
                    <bpel:target linkName="link2"></bpel:target>
                </bpel:targets>
            </bpel:invoke>
            
            <bpel:sequence name="Sequence1">
                <bpel:targets>
                    <bpel:target linkName="link3"></bpel:target>
                    <bpel:target linkName="link4"></bpel:target>
                    <bpel:target linkName="link5"></bpel:target>
                </bpel:targets>
                
                <bpel:if name="If"><bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$studentLinkResponse.parameters/ns1:return="student does not exist"]]></bpel:condition>
                    <bpel:assign validate="no" name="Assign">
                        <bpel:copy>
                            <bpel:from><bpel:literal><ns:orderBookResponse xmlns:ns="http://waa.swin.artifacts" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <replyResponse>StudentValidationFailed</replyResponse>
</ns:orderBookResponse>
</bpel:literal></bpel:from>
                            <bpel:to variable="clientInputLinkResponse" part="parameters"></bpel:to>
                        </bpel:copy>
                        
                    </bpel:assign>
                    <bpel:elseif>
                        <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$bookLibLinkResponse.parameters/ns0:return="true"]]></bpel:condition>
                        <bpel:assign validate="no" name="Assign1">
                            <bpel:copy>
                                <bpel:from><bpel:literal><ns:orderBookResponse xmlns:ns="http://waa.swin.artifacts" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <replyResponse>BookAlreadyExist</replyResponse>
</ns:orderBookResponse>
</bpel:literal></bpel:from>
                                <bpel:to variable="clientInputLinkResponse" part="parameters"></bpel:to>
                            </bpel:copy>
                            
                        </bpel:assign>
                    </bpel:elseif><bpel:elseif>
                        <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$bookShopLinkResponse.parameters/ns2:return=""]]></bpel:condition>
                        <bpel:sequence>
                            <bpel:assign validate="no" name="assignForGetInfo">
                                <bpel:copy>
                                    <bpel:from><bpel:literal><ns:getAllDetailBook xmlns:ns="http://sw.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ns:isbn>ns:isbn</ns:isbn>
</ns:getAllDetailBook>
</bpel:literal></bpel:from>
                                    <bpel:to variable="bookShopLinkRequest1" part="parameters"></bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from part="parameters" variable="clientInputLinkRequest">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[isbn]]></bpel:query>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="bookShopLinkRequest1">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns2:isbn]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                            </bpel:assign>
                            <bpel:invoke name="invokeGetInfo" partnerLink="bookShopLink" operation="getAllDetailBook" portType="ns2:Ass02BookInformationPortType" inputVariable="bookShopLinkRequest1" outputVariable="bookShopLinkResponse1"></bpel:invoke>
                            <bpel:assign validate="no" name="assignForUpdating">
                                <bpel:copy>
                                    <bpel:from><bpel:literal><ns:orderBookByBpel xmlns:ns="http://waa.swin.edu.au" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <ns:studentId>0</ns:studentId>
  <ns:bookinfo>ns:bookinfo</ns:bookinfo>
</ns:orderBookByBpel>
</bpel:literal></bpel:from>
                                    <bpel:to variable="bookLibLinkRequest1" part="parameters"></bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from part="parameters" variable="clientInputLinkRequest">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[studentId]]></bpel:query>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="bookLibLinkRequest1">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns0:studentId]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                                <bpel:copy>
                                    <bpel:from part="parameters" variable="bookShopLinkResponse1">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns2:return]]></bpel:query>
                                    </bpel:from>
                                    <bpel:to part="parameters" variable="bookLibLinkRequest1">
                                        <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns0:bookinfo]]></bpel:query>
                                    </bpel:to>
                                </bpel:copy>
                            </bpel:assign>
                            <bpel:invoke name="invokeUpdating" partnerLink="bookLibLink" operation="orderBookByBpel" portType="ns0:Ass02BookSoapPortType" inputVariable="bookLibLinkRequest1" outputVariable="bookLibLinkResponse1"></bpel:invoke>
                            <bpel:assign validate="no" name="Assign2">
                            <bpel:copy>
                                <bpel:from><bpel:literal><ns:orderBookResponse xmlns:ns="http://waa.swin.artifacts" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <replyResponse>bookOrderSuccessfully</replyResponse>
</ns:orderBookResponse>
</bpel:literal></bpel:from>
                                <bpel:to variable="clientInputLinkResponse" part="parameters"></bpel:to>
                            </bpel:copy>
                            
                        </bpel:assign>
                            
                            
                            
                            
                        </bpel:sequence>
                    </bpel:elseif><bpel:else>
                        <bpel:assign validate="no" name="Assign3">
                            <bpel:copy>
                                <bpel:from><bpel:literal><ns:orderBookResponse xmlns:ns="http://waa.swin.artifacts" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <replyResponse>replyResponse</replyResponse>
</ns:orderBookResponse>
</bpel:literal></bpel:from>
                                <bpel:to variable="clientInputLinkResponse" part="parameters"></bpel:to>
                            </bpel:copy>
                            <bpel:copy>
                                <bpel:from part="parameters" variable="bookShopLinkResponse">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns2:return]]></bpel:query>
                                </bpel:from>
                                <bpel:to part="parameters" variable="clientInputLinkResponse">
                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[replyResponse]]></bpel:query>
                                </bpel:to>
                            </bpel:copy>
                        </bpel:assign>
                    </bpel:else>
                </bpel:if>
            </bpel:sequence></bpel:flow>
        
        <bpel:reply name="replyOutput" partnerLink="clientInputLink" operation="orderBook" portType="ns:bookOrderPortType" variable="clientInputLinkResponse"></bpel:reply>
    </bpel:sequence>    
</bpel:process>

